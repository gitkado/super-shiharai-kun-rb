# specs/ ディレクトリ運用ガイド

Claude Codeのサブエージェント（architect / implementer / committer）が検討内容をリポジトリに残すためのディレクトリ構成と記述ルールをまとめます。

> **注記**: 既存の機能フォルダ（`authentication/`, `invoice-management/`, `vscode-lsp-setup/`）は旧テンプレートで運用されています。新規機能から本ガイドラインを適用してください。

## ディレクトリ構造

```
specs/
├─ README.md            # 本ガイド
└─ <feature_slug>/      # 機能単位のディレクトリ（ケバブケース）
   ├─ requirements.md   # 要件定義・背景・非機能要件など
   ├─ design.md         # 設計判断・パッケージ構造・API方針
   └─ tasks.md          # 実装タスク・コミット計画・進捗ログ
```

- `<feature_slug>` は対象機能を表すケバブケース（例: `invoice-approval-flow`）
- 既存ディレクトリがあれば追記し、新規機能はディレクトリを作成してから記述

---

## requirements.md

要件定義・背景情報を記載するファイル。architectサブエージェントが主に更新。

### セクション構成

1. **背景 / 目的** - なぜこの機能が必要か
2. **現状の課題** - 解決したい問題点
3. **スコープ / 非スコープ** - 含むもの・含まないものを明確に
4. **ビジネス / ユーザーフロー** - Mermaid図推奨
5. **非機能要件** - 性能、監査、可観測性、セキュリティなど
6. **ステークホルダーと責務** - 関係者の役割
7. **計測指標・成功条件** - KPI、達成基準
8. **受け入れ基準** - 完了判定の具体的条件

必要に応じてチェックリストを使い、検討済みかを明示してください。

---

## design.md

設計判断・技術仕様を記載するファイル。architectサブエージェントが主に更新。

### セクション構成

1. **重要な設計判断と理由** - ADR形式推奨
2. **Packwerkパッケージ構造** - 依存関係、公開API
3. **エンティティ / DTO / 値オブジェクト** - データモデル定義
4. **API仕様** - エンドポイント、リクエスト/レスポンス形式
5. **データフロー・シーケンス** - Mermaid記法可
6. **イベント設計** - 非同期処理、ドメインイベント（該当時のみ）
7. **エラー設計** - エラーコード、例外処理方針（該当時のみ）
8. **監視・可観測性** - ログ、メトリクス、アラート（該当時のみ）
9. **テスト戦略** - 観点、境界、テストダブル方針
10. **リスク・未解決事項・代替案**

> セクション6〜8はオプショナル。該当する場合のみ記載。

要件差異が発生した場合は requirements.md も合わせて更新します。

---

## tasks.md

実装タスク・進捗管理を記載するファイル。implementer / committerサブエージェントが主に更新。

### セクション構成

1. **実装タスク** - チェックリスト形式を推奨
2. **状態遷移表** - 各タスクの状態（pending / in_progress / completed）
3. **コミット計画** - committerが作成、`<details>` タグで折りたたみ推奨
4. **進捗ログ** - 実装結果・検証コマンド・残課題

### コミット計画のテンプレート

```markdown
## コミット計画

<!-- committerサブエージェントが生成・更新 -->

<details>
<summary>コミット一覧（クリックで展開）</summary>

### 全体サマリ
- 変更概要: ...
- 想定リスク: ...

### コミット分割

| # | 種別 | スコープ | 概要 | 対象ファイル |
|---|------|----------|------|--------------|
| 1 | feat | pack-xxx | ... | app/packages/xxx/... |
| 2 | test | pack-xxx | ... | spec/... |

### 詳細

#### コミット1: feat(pack-xxx): ...
- 本文: ...
- 対象ファイル: ...

</details>
```

---

## 更新フロー

```
[要件整理]                    [設計検討]                    [実装]
    │                             │                           │
    ▼                             ▼                           ▼
architect                     architect                   implementer
requirements.md ────────────▶ design.md ────────────────▶ tasks.md
                                                              │
                                                              ▼
                                                          committer
                                                      tasks.md (コミット計画)
```

### サブエージェントの責務

| サブエージェント | 主な更新対象 | 役割 |
|------------------|--------------|------|
| architect | requirements.md, design.md | 要件整理・設計判断 |
| implementer | tasks.md | 実装タスク管理・進捗更新 |
| committer | tasks.md (コミット計画) | コミット分割・計画作成 |

差分が出た場合は関連ファイルも合わせて更新する。
